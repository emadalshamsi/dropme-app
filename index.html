<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>DropMe - Minimalist File Transfer</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary-blue": "#2563eb",
                        "soft-blue": "#eff6ff",
                        "pastel-blue": "#e0f2fe",
                        "pastel-purple": "#f3e8ff",
                        "pastel-green": "#dcfce7",
                        "pastel-orange": "#ffedd5",
                        "pastel-pink": "#fce7f3",
                        "pastel-yellow": "#fef9c3",
                        "background-white": "#ffffff",
                        "surface-offwhite": "#fafafa",
                        "border-light": "#f1f5f9",
                        "text-charcoal": "#0f172a",
                        "text-subtle": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "1.5rem",
                        "xl": "2.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body {
                background-color: #ffffff;
                color: #0f172a;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                overflow-x: hidden;
            }
        }
        .drop-zone-dashed {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='32' ry='32' stroke='%232563eb' stroke-width='2' stroke-dasharray='10%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            border-radius: 2rem;
        }
        .pulse-ring {
            position: absolute;
            border-radius: 9999px;
            border-width: 2px;
            border-color: rgba(37, 99, 235, 0.2);
            animation: pulse-animation 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-animation {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>

<body class="font-display min-h-screen flex flex-col selection:bg-primary-blue selection:text-white">
    <header class="flex items-center justify-between px-8 md:px-12 py-5 bg-white z-20">
        <div class="flex items-center gap-3">
            <div
                class="size-11 flex items-center justify-center bg-gradient-to-br from-blue-600 to-blue-400 rounded-xl shadow-lg shadow-blue-500/20">
                <span class="text-white text-2xl font-black italic tracking-tighter">D</span>
            </div>
            <h2 class="text-text-charcoal text-2xl font-extrabold tracking-tight">DropMe</h2>
        </div>
        <div class="flex items-center gap-6">
            <div
                class="hidden lg:flex items-center gap-3 px-5 py-2 rounded-full bg-surface-offwhite border border-border-light">
                <div class="size-2 bg-green-500 rounded-full"></div>
                <span class="text-xs font-semibold text-text-subtle uppercase tracking-wider">Mesh Network: <span
                        id="network-name" class="text-text-charcoal font-bold font-mono">Loading...</span></span>
            </div>
            <div id="self-device-info"
                class="flex items-center gap-3 bg-soft-blue/50 px-4 py-2 rounded-xl border border-blue-100">
                <div class="size-8 rounded-lg bg-primary-blue flex items-center justify-center text-white text-xs font-bold"
                    id="my-avatar-initial">?</div>
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-primary-blue uppercase leading-none mb-0.5">You</span>
                    <span class="text-xs font-bold text-text-charcoal leading-none"
                        id="my-device-name">Waiting...</span>
                </div>
            </div>
        </div>
    </header>
    <main class="flex-1 flex flex-col items-center justify-start pt-8 pb-12 px-6 relative">
        <div
            class="absolute inset-0 pointer-events-none overflow-hidden flex items-center justify-center -z-10 opacity-40">
            <div class="w-[400px] h-[400px] rounded-full border border-blue-50/50"></div>
            <div class="absolute w-[700px] h-[700px] rounded-full border border-blue-50/30"></div>
        </div>
        <div class="w-full max-w-4xl flex flex-col items-center">
            <div
                class="mb-10 p-1.5 bg-surface-offwhite border border-border-light rounded-2xl flex items-center shadow-sm">
                <button id="toggle-send"
                    class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all bg-white text-primary-blue shadow-sm">
                    Send
                </button>
                <button id="toggle-receive"
                    class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-text-subtle hover:text-text-charcoal">
                    Receive
                </button>
            </div>
            <div class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-3 text-text-charcoal tracking-tight">
                    Ready to <span class="text-primary-blue">share</span>
                </h1>
                <p class="text-text-subtle text-lg font-medium max-w-md mx-auto">Drop files below to instantly send them
                    to anyone nearby.</p>
            </div>
            <div id="send-view" class="w-full">
                <div id="drop-zone"
                    class="relative w-full h-32 md:h-40 drop-zone-dashed bg-white hover:bg-soft-blue/30 transition-all duration-500 group cursor-pointer shadow-[0_20px_40px_-12px_rgba(0,0,0,0.04)] flex flex-col items-center justify-center gap-3 mb-10">
                    <div
                        class="size-16 rounded-2xl bg-pastel-blue text-primary-blue flex items-center justify-center group-hover:scale-105 transition-transform duration-300 shadow-sm border border-white">
                        <span class="material-symbols-outlined text-3xl">upload_file</span>
                    </div>
                    <div class="text-center px-6">
                        <p class="text-xl font-bold text-text-charcoal mb-0">Drag & Drop files here</p>
                        <p class="text-text-subtle font-medium text-sm">Direct peer-to-peer transfer</p>
                    </div>
                    <input type="file" id="file-input" class="hidden" />
                    <button id="select-button"
                        class="bg-primary-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl transition-all active:scale-95 shadow-lg shadow-blue-500/20 text-sm">
                        Select File
                    </button>
                </div>
                <!-- Progress Container -->
                <div id="progress-container"
                    class="w-full hidden mb-10 bg-white p-6 rounded-3xl border border-border-light shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex flex-col">
                            <span id="file-status-title"
                                class="text-xs font-bold text-text-subtle uppercase tracking-wider mb-1">Transfer
                                Session</span>
                            <span id="file-status-text"
                                class="text-base font-bold text-text-charcoal">Preparing...</span>
                        </div>
                        <span id="progress-percent" class="text-2xl font-black text-primary-blue">0%</span>
                    </div>
                    <div class="w-full h-3 bg-soft-blue rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-primary-blue transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="receive-view" class="w-full hidden items-center justify-center flex-col py-10">
                <div class="relative size-40 flex items-center justify-center mb-6">
                    <div class="pulse-ring w-full h-full"></div>
                    <div class="pulse-ring w-full h-full" style="animation-delay: 1s"></div>
                    <div class="pulse-ring w-full h-full" style="animation-delay: 2s"></div>
                    <div class="size-20 bg-soft-blue rounded-full flex items-center justify-center z-10">
                        <span class="material-symbols-outlined text-4xl text-primary-blue">radar</span>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-xl font-bold text-text-charcoal mb-1">Discovery Active</p>
                    <p class="text-text-subtle font-medium text-sm" id="receive-status">Waiting for incoming files...
                    </p>
                </div>
            </div>
            <div class="w-full max-w-4xl">
                <div class="flex items-center justify-center gap-4 mb-8">
                    <div class="h-px flex-1 max-w-[100px] bg-border-light"></div>
                    <h3 class="text-[11px] font-bold text-text-subtle uppercase tracking-[0.2em] whitespace-nowrap">
                        Nearby Devices</h3>
                    <div class="h-px flex-1 max-w-[100px] bg-border-light"></div>
                </div>
                <div id="device-list-container"
                    class="flex flex-wrap justify-center items-center gap-8 md:gap-12 min-h-[100px]">
                    <p class="text-text-subtle text-sm italic">Searching for devices...</p>
                </div>
            </div>
        </div>
    </main>
    <!-- Request Modal -->
    <div id="request-modal"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-white/40 backdrop-blur-[2px] p-4">
        <div
            class="relative w-full max-w-[440px] bg-white rounded-[2rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.1),0_10px_30px_-10px_rgba(0,0,0,0.04)] border border-slate-100/50 overflow-hidden flex flex-col">
            <div class="pt-10 pb-6 px-8 flex flex-col items-center">
                <div
                    class="size-20 rounded-full bg-emerald-50 flex items-center justify-center mb-6 ring-8 ring-emerald-50/30">
                    <span class="material-symbols-outlined text-green-500 text-4xl">file_download</span>
                </div>
                <h3 class="text-2xl font-extrabold text-slate-950 text-center tracking-tight">Incoming Request</h3>
                <p class="text-slate-500 mt-2 text-center font-medium">A device wants to share a file with you</p>
            </div>
            <div class="px-8 pb-10 flex flex-col gap-8">
                <div class="flex flex-col gap-5 bg-slate-50/80 rounded-2xl p-6 border border-slate-100">
                    <div class="flex items-center gap-4">
                        <div
                            class="size-12 rounded-full bg-white flex items-center justify-center text-slate-900 shadow-sm border border-slate-200">
                            <span class="material-symbols-outlined text-2xl">smartphone</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[11px] font-bold uppercase tracking-[0.1em] text-slate-400">Sender</span>
                            <span id="request-sender-name" class="text-base font-extrabold text-slate-900">Unknown
                                Device</span>
                        </div>
                    </div>
                    <div class="h-px bg-slate-200 w-full"></div>
                    <div class="flex items-center gap-4">
                        <div
                            class="size-14 rounded-xl bg-white text-green-500 flex items-center justify-center shrink-0 shadow-sm border border-slate-200">
                            <span class="material-symbols-outlined text-3xl">insert_drive_file</span>
                        </div>
                        <div class="flex flex-col min-w-0 flex-1">
                            <p id="request-file-name" class="text-base font-extrabold text-slate-950 truncate">file.pdf
                            </p>
                            <p id="request-file-size" class="text-sm font-semibold text-slate-600">0 MB</p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button id="decline-btn"
                        class="flex-1 h-14 rounded-2xl bg-white border-2 border-slate-100 hover:border-red-500 hover:bg-red-50 text-red-500 font-extrabold transition-all flex items-center justify-center gap-2 group">
                        <span class="material-symbols-outlined text-2xl font-bold">close</span>
                        Decline
                    </button>
                    <button id="accept-btn"
                        class="flex-1 h-14 rounded-2xl bg-primary-blue hover:bg-blue-700 text-white font-extrabold shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 group">
                        <span class="material-symbols-outlined text-2xl font-bold">check</span>
                        Accept
                    </button>
                </div>
                <div
                    class="flex items-center justify-center gap-2 px-4 py-2 bg-slate-50 rounded-full self-center border border-slate-100">
                    <span class="material-symbols-outlined text-green-500 text-sm font-bold">verified_user</span>
                    <span class="text-[11px] font-bold uppercase tracking-widest text-slate-500">Secure Transfer</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        const ws = new WebSocket(wsUrl);
        let myId = null;
        let myName = null;
        let peerConnections = {};
        let selectedFile = null;
        let incomingFileMetadata = {};
        let knownDevices = {}; // Store device info (id -> name)

        const toggleSend = document.getElementById('toggle-send');
        const toggleReceive = document.getElementById('toggle-receive');
        const sendView = document.getElementById('send-view');
        const receiveView = document.getElementById('receive-view');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const selectBtn = document.getElementById('select-button');
        const deviceListContainer = document.getElementById('device-list-container');
        const networkNameEl = document.getElementById('network-name');

        // Progress Elements
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const fileStatusText = document.getElementById('file-status-text');
        const fileStatusTitle = document.getElementById('file-status-title');

        // Self info elements
        const myAvatarInitial = document.getElementById('my-avatar-initial');
        const myDeviceNameEl = document.getElementById('my-device-name');

        // Set Network Name (derived from hostname or a cool ID)
        const networkId = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'Local_Mesh_Dev' : 'Mesh_' + window.location.hostname.replace(/\./g, '_');
        networkNameEl.textContent = networkId;

        // UI Toggling
        toggleSend.onclick = () => {
            sendView.classList.remove('hidden');
            receiveView.classList.add('hidden');
            toggleSend.className = "px-8 py-2.5 rounded-xl text-sm font-bold transition-all bg-white text-primary-blue shadow-sm";
            toggleReceive.className = "px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-text-subtle hover:text-text-charcoal";
        };

        toggleReceive.onclick = () => {
            sendView.classList.add('hidden');
            receiveView.classList.remove('hidden');
            receiveView.classList.add('flex');
            toggleReceive.className = "px-8 py-2.5 rounded-xl text-sm font-bold transition-all bg-white text-primary-blue shadow-sm";
            toggleSend.className = "px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-text-subtle hover:text-text-charcoal";
        };

        // File Selection
        selectBtn.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) alert(`Ready to send: ${selectedFile.name}`);
        };

        // Drag and Drop
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('bg-soft-blue/50'); };
        dropZone.ondragleave = () => dropZone.classList.remove('bg-soft-blue/50');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-soft-blue/50');
            selectedFile = e.dataTransfer.files[0];
            if (selectedFile) alert(`Ready to send: ${selectedFile.name}`);
        };

        // WebSocket Communication
        ws.onmessage = async (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'init') {
                myId = data.id;
                myName = `Device ${myId.substr(0, 4)}`;
                myAvatarInitial.textContent = myName.substr(7, 2).toUpperCase();
                myDeviceNameEl.textContent = myName + " (You)";
                console.log('Self-ID established:', myId);
            } else if (data.type === 'devices') {
                updateDeviceList(data.devices);
            } else if (data.type === 'signal') {
                handleSignal(data);
            } else if (data.type === 'transfer-request') {
                handleTransferRequest(data);
            } else if (data.type === 'transfer-response') {
                handleTransferResponse(data);
            }
        };

        // UI Elements for Modal
        const requestModal = document.getElementById('request-modal');
        const requestSenderName = document.getElementById('request-sender-name');
        const requestFileName = document.getElementById('request-file-name');
        const requestFileSize = document.getElementById('request-file-size');
        const acceptBtn = document.getElementById('accept-btn');
        const declineBtn = document.getElementById('decline-btn');

        let pendingRequest = null;

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function handleTransferRequest(data) {
            pendingRequest = data;
            requestSenderName.textContent = data.senderName;
            requestFileName.textContent = data.fileName;
            requestFileSize.textContent = formatBytes(data.fileSize);
            requestModal.classList.remove('hidden');
            requestModal.classList.add('flex');
        }

        acceptBtn.onclick = () => {
            if (!pendingRequest) return;
            ws.send(JSON.stringify({
                type: 'transfer-response',
                targetId: pendingRequest.senderId,
                accepted: true
            }));
            requestModal.classList.add('hidden');
            requestModal.classList.remove('flex');
            // Show receive progress
            progressContainer.classList.remove('hidden');
            fileStatusTitle.textContent = "Waiting for Transfer";
            fileStatusText.textContent = `Accepted ${pendingRequest.fileName} from ${pendingRequest.senderName}`;
        };

        declineBtn.onclick = () => {
            if (!pendingRequest) return;
            ws.send(JSON.stringify({
                type: 'transfer-response',
                targetId: pendingRequest.senderId,
                accepted: false
            }));
            requestModal.classList.add('hidden');
            requestModal.classList.remove('flex');
            pendingRequest = null;
        };

        function handleTransferResponse(data) {
            if (data.accepted) {
                fileStatusText.textContent = "Request accepted! Starting transfer...";
                startWebRTCTransfer(data.senderId);
            } else {
                alert("Transfer request was declined.");
                progressContainer.classList.add('hidden');
            }
        }

        function updateDeviceList(devices) {
            deviceListContainer.innerHTML = '';
            knownDevices = {};
            const otherDevices = devices.filter(d => d.id !== myId);

            if (otherDevices.length === 0) {
                deviceListContainer.innerHTML = '<p class="text-text-subtle text-sm italic">Searching for devices...</p>';
                return;
            }

            otherDevices.forEach(device => {
                knownDevices[device.id] = device.name;
                const devEl = document.createElement('div');
                devEl.className = "flex flex-col items-center gap-3 group cursor-pointer";
                devEl.innerHTML = `
                    <div class="relative">
                        <div class="size-20 rounded-[2rem] bg-pastel-blue border-4 border-white shadow-md group-hover:shadow-xl group-hover:-translate-y-1 transition-all flex items-center justify-center overflow-hidden">
                            <span class="font-bold text-primary-blue uppercase">${device.name.substr(7, 2)}</span>
                        </div>
                    </div>
                    <span class="text-sm font-bold text-text-charcoal group-hover:text-primary-blue transition-colors">${device.name}</span>
                `;
                devEl.onclick = () => initiateTransfer(device.id);
                deviceListContainer.appendChild(devEl);
            });
        }

        async function initiateTransfer(targetId) {
            if (!selectedFile) {
                alert('Please select a file first!');
                return;
            }

            const targetName = knownDevices[targetId] || "Peer";

            // Send request instead of starting WebRTC
            ws.send(JSON.stringify({
                type: 'transfer-request',
                targetId: targetId,
                senderId: myId,
                senderName: myName,
                fileName: selectedFile.name,
                fileSize: selectedFile.size
            }));

            // UI Update for sender
            fileStatusTitle.textContent = "Transfer Request";
            fileStatusText.textContent = `Waiting for ${targetName} to accept...`;
            progressContainer.classList.remove('hidden');
        }

        async function startWebRTCTransfer(targetId) {
            const pc = createPeerConnection(targetId);
            peerConnections[targetId] = pc;

            const dc = pc.createDataChannel('fileTransfer');
            setupDataChannel(dc, targetId, true);

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            ws.send(JSON.stringify({
                type: 'signal',
                targetId: targetId,
                signal: { type: 'offer', sdp: offer.sdp }
            }));
        }

        async function handleSignal(data) {
            let pc = peerConnections[data.senderId];
            if (!pc) {
                pc = createPeerConnection(data.senderId);
                peerConnections[data.senderId] = pc;
            }

            if (data.signal.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.signal));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({
                    type: 'signal',
                    targetId: data.senderId,
                    signal: { type: 'answer', sdp: answer.sdp }
                }));
            } else if (data.signal.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.signal));
            } else if (data.signal.candidate) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(data.signal));
                } catch (e) {
                    console.warn('ICE candidate failed', e);
                }
            }
        }

        function createPeerConnection(targetId) {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    ws.send(JSON.stringify({
                        type: 'signal',
                        targetId: targetId,
                        signal: { candidate: e.candidate.candidate, sdpMid: e.candidate.sdpMid, sdpMLineIndex: e.candidate.sdpMLineIndex }
                    }));
                }
            };

            pc.ondatachannel = (e) => {
                const dc = e.channel;
                dc.binaryType = 'arraybuffer';
                setupDataChannel(dc, targetId, false);
            };

            return pc;
        }

        function setupDataChannel(dc, peerId, isSender) {
            dc.binaryType = 'arraybuffer';
            let receivedChunks = [];
            let receivedSize = 0;
            const peerName = knownDevices[peerId] || "Peer";

            dc.onopen = () => {
                if (isSender) {
                    console.log('Sender channel open, sending metadata...');
                    fileStatusText.textContent = `Sending ${selectedFile.name} to ${peerName}`;

                    // Send metadata first
                    dc.send(JSON.stringify({ type: 'metadata', name: selectedFile.name, size: selectedFile.size }));

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const buffer = e.target.result;
                        const CHUNK_SIZE = 16384;
                        let offset = 0;

                        const sendNextChunk = () => {
                            while (offset < buffer.byteLength && dc.bufferedAmount < 1024 * 1024) {
                                const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
                                dc.send(chunk);
                                offset += chunk.byteLength;

                                const percent = Math.floor((offset / buffer.byteLength) * 100);
                                progressBar.style.width = `${percent}%`;
                                progressPercent.textContent = `${percent}%`;
                            }
                            if (offset < buffer.byteLength) {
                                setTimeout(sendNextChunk, 10);
                            } else {
                                dc.send('EOF');
                                fileStatusText.textContent = `File sent successfully to ${peerName}!`;
                            }
                        };
                        sendNextChunk();
                    };
                    reader.readAsArrayBuffer(selectedFile);
                }
            };

            dc.onmessage = (e) => {
                if (typeof e.data === 'string') {
                    if (e.data.startsWith('{')) {
                        try {
                            const info = JSON.parse(e.data);
                            if (info.type === 'metadata') {
                                incomingFileMetadata = info;
                                progressContainer.classList.remove('hidden');
                                fileStatusTitle.textContent = "Receiving File";
                                fileStatusText.textContent = `Receiving ${info.name} from ${peerName}`;
                                receivedChunks = [];
                                receivedSize = 0;
                            }
                        } catch (err) { console.error('Metadata parse error', err); }
                    } else if (e.data === 'EOF') {
                        const fileName = incomingFileMetadata.name || 'received_file';
                        console.log('EOF received, saving as:', fileName);
                        const blob = new Blob(receivedChunks);
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.click();
                        fileStatusText.textContent = `File ${fileName} received from ${peerName}!`;
                        receivedChunks = [];
                        incomingFileMetadata = {};
                    }
                } else {
                    receivedChunks.push(e.data);
                    receivedSize += e.data.byteLength;
                    if (incomingFileMetadata.size) {
                        const percent = Math.floor((receivedSize / incomingFileMetadata.size) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressPercent.textContent = `${percent}%`;
                    }
                }
            };
        }
    </script>
</body>

</html>